From 83d85fa8e9ebe647205d550cdceeb0386690ec93 Mon Sep 17 00:00:00 2001
From: Mikolaj Izdebski <mizdebsk@redhat.com>
Date: Sun, 24 Apr 2022 23:10:50 +0200
Subject: [PATCH] Disable incremental compilation

Forwarded: not-needed
---
 .../plugin/compiler/AbstractCompilerMojo.java | 67 +------------------
 1 file changed, 2 insertions(+), 65 deletions(-)

diff --git a/src/main/java/org/apache/maven/plugin/compiler/AbstractCompilerMojo.java b/src/main/java/org/apache/maven/plugin/compiler/AbstractCompilerMojo.java
index e0ec1db..8e7d678 100644
--- a/src/main/java/org/apache/maven/plugin/compiler/AbstractCompilerMojo.java
+++ b/src/main/java/org/apache/maven/plugin/compiler/AbstractCompilerMojo.java
@@ -56,8 +56,6 @@ import org.apache.maven.plugins.annotations.Component;
 import org.apache.maven.plugins.annotations.Parameter;
 import org.apache.maven.project.MavenProject;
 import org.apache.maven.repository.RepositorySystem;
-import org.apache.maven.shared.incremental.IncrementalBuildHelper;
-import org.apache.maven.shared.incremental.IncrementalBuildHelperRequest;
 import org.apache.maven.shared.utils.ReaderFactory;
 import org.apache.maven.shared.utils.StringUtils;
 import org.apache.maven.shared.utils.io.FileUtils;
@@ -537,7 +535,7 @@ public abstract class AbstractCompilerMojo
      *
      * @since 3.1
      */
-    @Parameter( defaultValue = "true", property = "maven.compiler.useIncrementalCompilation" )
+    @Parameter( defaultValue = "false", property = "maven.compiler.useIncrementalCompilation" )
     private boolean useIncrementalCompilation = true;
 
     /**
@@ -846,47 +844,11 @@ public abstract class AbstractCompilerMojo
 
         boolean canUpdateTarget;
 
-        IncrementalBuildHelper incrementalBuildHelper = new IncrementalBuildHelper( mojoExecution, session );
-
         final Set<File> sources;
 
-        IncrementalBuildHelperRequest incrementalBuildHelperRequest = null;
-
         if ( useIncrementalCompilation )
         {
-            getLog().debug( "useIncrementalCompilation enabled" );
-            try
-            {
-                canUpdateTarget = compiler.canUpdateTarget( compilerConfiguration );
-
-                sources = getCompileSources( compiler, compilerConfiguration );
-                
-                preparePaths( sources );
-
-                incrementalBuildHelperRequest = new IncrementalBuildHelperRequest().inputFiles( sources );
-
-                // CHECKSTYLE_OFF: LineLength
-                if ( ( compiler.getCompilerOutputStyle().equals( CompilerOutputStyle.ONE_OUTPUT_FILE_FOR_ALL_INPUT_FILES ) && !canUpdateTarget )
-                    || isDependencyChanged()
-                    || isSourceChanged( compilerConfiguration, compiler )
-                    || incrementalBuildHelper.inputFileTreeChanged( incrementalBuildHelperRequest ) )
-                    // CHECKSTYLE_ON: LineLength
-                {
-                    getLog().info( "Changes detected - recompiling the module!" );
-
-                    compilerConfiguration.setSourceFiles( sources );
-                }
-                else
-                {
-                    getLog().info( "Nothing to compile - all classes are up to date" );
-
-                    return;
-                }
-            }
-            catch ( CompilerException e )
-            {
-                throw new MojoExecutionException( "Error while computing stale sources.", e );
-            }
+	    throw new MojoExecutionException( "incremental builds not supported" );
         }
         else
         {
@@ -1192,16 +1154,6 @@ public abstract class AbstractCompilerMojo
 
         CompilerResult compilerResult;
 
-
-        if ( useIncrementalCompilation )
-        {
-            incrementalBuildHelperRequest.outputDirectory( getOutputDirectory() );
-
-            incrementalBuildHelper.beforeRebuildExecution( incrementalBuildHelperRequest );
-
-            getLog().debug( "incrementalBuildHelper#beforeRebuildExecution" );
-        }
-
         try
         {
             try
@@ -1235,21 +1187,6 @@ public abstract class AbstractCompilerMojo
             }
         }
 
-        if ( useIncrementalCompilation )
-        {
-            if ( incrementalBuildHelperRequest.getOutputDirectory().exists() )
-            {
-                getLog().debug( "incrementalBuildHelper#afterRebuildExecution" );
-                // now scan the same directory again and create a diff
-                incrementalBuildHelper.afterRebuildExecution( incrementalBuildHelperRequest );
-            }
-            else
-            {
-                getLog().debug(
-                    "skip incrementalBuildHelper#afterRebuildExecution as the output directory doesn't exist" );
-            }
-        }
-
         List<CompilerMessage> warnings = new ArrayList<>();
         List<CompilerMessage> errors = new ArrayList<>();
         List<CompilerMessage> others = new ArrayList<>();
-- 
2.35.1

